name: Terraform Destroy
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "destroy" to confirm deletion of all resources'
        required: true
        default: ''
      environment:
        description: 'Environment to destroy (optional for logging)'
        required: false
        default: 'development'
jobs:
  destroy:
    runs-on: ubuntu-latest
    
    # Solo ejecuta si se confirma explÃ­citamente
    if: github.event.inputs.confirm == 'destroy'
    
    defaults:
      run:
        working-directory: ./terraform
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Configure Terraform for Azure CLI
      run: |
        # Configurar Terraform para usar Azure CLI
        export ARM_USE_CLI=true
        export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)
        echo "ARM_USE_CLI=true" >> $GITHUB_ENV
        echo "ARM_SUBSCRIPTION_ID=$ARM_SUBSCRIPTION_ID" >> $GITHUB_ENV
        echo "ARM_TENANT_ID=$ARM_TENANT_ID" >> $GITHUB_ENV
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 'latest'
    
    - name: Terraform Init
      run: terraform init
    
    - name: Terraform Validate
      run: terraform validate
    
    - name: Show Destroy Plan
      run: terraform plan -destroy
      continue-on-error: true
    
    - name: Wait for confirmation
      run: |
        echo "âš ï¸  About to destroy all Terraform-managed resources"
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment }}"
        echo "ğŸ‘¤ Initiated by: ${{ github.actor }}"
        echo "â° Timestamp: $(date)"
        echo ""
        echo "Proceeding with destruction in 10 seconds..."
        sleep 10
    
    - name: Terraform Destroy
      run: terraform destroy -auto-approve
    
    - name: Confirm Destruction
      run: |
        echo "âœ… Resources have been destroyed successfully"
        echo "ğŸŒ Environment: ${{ github.event.inputs.environment }}"
        echo "ğŸ‘¤ Destroyed by: ${{ github.actor }}"
        echo "â° Completed at: $(date)"